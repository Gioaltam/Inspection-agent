<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Property Report</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;margin:24px;max-width:900px}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0}
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #222;text-decoration:none}
    .btn+.btn{margin-left:8px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px 16px}
    code{background:#f6f8fa;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <h1 id="addr">Property Report</h1>
  <div class="card">
    <div class="kv">
      <div>Report ID</div><div id="rid">-</div>
      <div>Client</div><div id="cid">-</div>
      <div>Property</div><div id="pid">-</div>
      <div>Created</div><div id="created">-</div>
    </div>
    <p>
      <a id="btn-pdf" class="btn" href="#" target="_blank">Download PDF</a>
      <a id="btn-interactive" class="btn" href="#" target="_blank">Open Interactive</a>
      <a id="btn-json" class="btn" href="#" target="_blank">View JSON</a>
    </p>
  </div>

  <script>
    // URL shape: /portal/<clientId>/<propertyId>/<reportId>
    const parts = location.pathname.split("/").filter(Boolean);
    const i = parts.indexOf("portal");
    const clientId   = parts[i+1], propertyId = parts[i+2], reportId = parts[i+3];

    async function load() {
      // Your backend should serve index.json at /api/report/<client>/<prop>/<report>/index.json
      const jsonUrl = `/api/report/${clientId}/${propertyId}/${reportId}/index.json`;
      const data = await fetch(jsonUrl).then(r => r.json());

      document.getElementById("addr").textContent = data.address ?? "Property Report";
      document.getElementById("rid").textContent = data.reportId || data.report_id || reportId;
      document.getElementById("cid").textContent = data.clientId || clientId;
      document.getElementById("pid").textContent = data.propertyId || propertyId;
      document.getElementById("created").textContent = (data.createdAt || data.generated_at || "").toString();

      // Buttons
      document.getElementById("btn-pdf").href = data.pdf?.presignedUrl || `/api/report/${clientId}/${propertyId}/${reportId}/report.pdf`;
      document.getElementById("btn-interactive").href = data.interactive?.basePath
        ? `/static/${data.interactive.basePath}index.html`
        : `/api/report/${clientId}/${propertyId}/${reportId}/interactive/index.html`;
      document.getElementById("btn-json").href = jsonUrl;
    }
    load().catch(err => alert("Failed to load report JSON: " + err));
  </script>
</body>
</html>