<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Inspection Report Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body { margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background:#f5f7fa; color:#2c3e50; }
    .header { background:#fff; padding:1.25rem; box-shadow:0 2px 4px rgba(0,0,0,.06); }
    .wrap { max-width:1200px; margin:0 auto; }
    h1 { font-size:1.5rem; margin:0 0 .25rem; }
    .muted { color:#718096; font-size:.95rem; }

    .container { max-width:1200px; margin:2rem auto; padding:0 1rem; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:1rem; }

    .card { background:#fff; border-radius:10px; padding:1.25rem; box-shadow:0 1px 3px rgba(0,0,0,.08); }
    .card.info { border-left:4px solid #3182ce; }
    .card.critical { border-left:4px solid #e53e3e; }
    .card.important { border-left:4px solid #ed8936; }
    .label { color:#718096; font-size:.875rem; margin-bottom:.5rem; }
    .value { font-size:2rem; font-weight:700; }

    .tabs { background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 1px 3px rgba(0,0,0,.08); }
    .tabs-margin { margin-top:1.25rem; }
    .tabbar { display:flex; border-bottom:2px solid #e2e8f0; overflow-x:auto; }
    .tabbar button { padding:1rem 1.25rem; background:none; border:0; color:#718096; font-weight:600; cursor:pointer; white-space:nowrap; }
    .tabbar button.active { color:#3182ce; position:relative; }
    .tabbar button.active::after { content:''; position:absolute; left:0; right:0; bottom:-2px; height:2px; background:#3182ce; }
    .content { padding:1.25rem; min-height:400px; }

    .photos { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px,1fr)); gap:1rem; }
    .photo { background:#f7fafc; border-radius:8px; overflow:hidden; cursor:pointer; transition: transform .2s, box-shadow .2s; }
    .photo:hover { transform: translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.12); }
    .thumb { width:100%; height:200px; object-fit:cover; display:block; }
    .info { padding:.75rem 1rem; }
    .loc { font-weight:700; }
    .badges { margin-top:.5rem; display:flex; gap:.5rem; }
    .badge { font-size:.75rem; font-weight:700; text-transform:uppercase; padding:.25rem .6rem; border-radius:999px; }
    .badge.critical { background:#fed7d7; color:#c53030; }
    .badge.important { background:#feebc8; color:#c05621; }

    .list { list-style:none; padding:0; margin:0; display:grid; gap:.75rem; }
    .item { background:#f7fafc; border-left:3px solid #cbd5e0; border-radius:6px; padding:1rem; }
    .item.critical { background:#fff5f5; border-left-color:#e53e3e; }
    .item.important { background:#fffaf0; border-left-color:#ed8936; }
    .tab-content-hidden { display:none; }
    .location-section { margin-bottom:1rem; }
    .location-title { margin:.25rem 0 .5rem; }

    .floating { position:fixed; right:1.25rem; bottom:1.25rem; display:flex; flex-direction:column; gap:.75rem; }
    .btn { background:#3182ce; color:#fff; border:0; border-radius:8px; padding:.75rem 1rem; font-weight:600; cursor:pointer; }
    .btn.secondary { background:#718096; }
    .btn:disabled { opacity:.55; cursor:not-allowed; }

    .modal { position:fixed; inset:0; background:rgba(0,0,0,.85); display:none; align-items:center; justify-content:center; z-index:1000; }
    .modal.show { display:flex; }
    .modal img { max-width:90vw; max-height:90vh; object-fit:contain; }
    .modal .x { position:absolute; top:1rem; right:1rem; background:none; color:#fff; font-size:2rem; border:0; cursor:pointer; }

    .loading { text-align:center; color:#718096; padding:2rem 0; }
    .spinner { width:42px; height:42px; border-radius:50%; border:3px solid #e2e8f0; border-top-color:#3182ce; animation:spin 1s linear infinite; margin:0 auto .6rem; will-change:transform; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .error { background:#fed7d7; color:#c53030; padding:1rem; border-radius:8px; margin:2rem 0; text-align:center; }
  </style>
</head>
<body>
  <div class="header">
    <div class="wrap">
      <h1 id="addr">Loading…</h1>
      <div class="muted" id="date">Inspection Date: —</div>
    </div>
  </div>

  <div class="container">
    <div id="error" class="error" style="display: none;"></div>
    
    <div class="grid">
      <div class="card info">
        <div class="label">Total Photos</div>
        <div class="value" id="total">—</div>
      </div>
      <div class="card critical">
        <div class="label">Critical Issues</div>
        <div class="value" id="crit">—</div>
      </div>
      <div class="card important">
        <div class="label">Important Issues</div>
        <div class="value" id="imp">—</div>
      </div>
    </div>

    <div class="tabs tabs-margin">
      <div class="tabbar">
        <button type="button" class="active" data-tab="all">All Photos</button>
        <button type="button" data-tab="location">By Location</button>
        <button type="button" data-tab="observations">Observations</button>
        <button type="button" data-tab="issues">Potential Issues</button>
        <button type="button" data-tab="recs">Recommendations</button>
      </div>
      <div class="content">
        <div id="tab-all">
          <div id="grid" class="photos">
            <div class="loading"><div class="spinner"></div>Loading report…</div>
          </div>
        </div>
        <div id="tab-location" class="tab-content-hidden"></div>
        <div id="tab-observations" class="tab-content-hidden"><ul id="list-ob" class="list"></ul></div>
        <div id="tab-issues" class="tab-content-hidden"><ul id="list-iss" class="list"></ul></div>
        <div id="tab-recs" class="tab-content-hidden"><ul id="list-rec" class="list"></ul></div>
      </div>
    </div>
  </div>

  <div class="floating">
    <button type="button" id="btn-std" class="btn">Download Standard PDF</button>
    <button type="button" id="btn-hq" class="btn secondary">Download High‑Quality PDF</button>
  </div>

  <div class="modal" id="modal">
    <button type="button" class="x" id="x">&times;</button>
    <img id="img" alt="">
  </div>

  <script>
    const qs = (s, r=document) => r.querySelector(s);
    const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));

    const url = new URL(location.href);
    const reportId = url.searchParams.get('id');
    const token = url.searchParams.get('token');
    
    const API_BASE = window.location.origin;

    let report, pdfs;

    async function load() {
      if (!reportId) {
        showError('No report ID provided');
        return;
      }
      
      if (!token) {
        showError('No access token provided. Please use a valid portal link.');
        return;
      }
      
      try {
        // Use the portal API endpoint with token authentication
        const resp = await fetch(`${API_BASE}/api/portal/reports/${reportId}?token=${encodeURIComponent(token)}`);
        
        if (!resp.ok) {
          if (resp.status === 401) {
            throw new Error('Invalid or expired access token');
          } else if (resp.status === 404) {
            throw new Error('Report not found or access denied');
          }
          throw new Error(`Failed to load report: ${resp.status} ${resp.statusText}`);
        }
        
        const data = await resp.json();
        
        // The portal endpoint returns the raw JSON report data
        report = data;
        
        // Extract PDF URLs
        pdfs = {
          standard: `${API_BASE}/api/portal/reports/${reportId}/pdf?token=${encodeURIComponent(token)}`,
          highquality: null // High quality variant not exposed via portal API
        };
        
        renderHeader(data);
        renderSummary(data.totals || {});
        renderPhotos(data.photos || []);
        renderByLocation(data.photos || []);
        renderLists(data.photos || []);
        wireDownloads();
        wireTabs();
        wireModal();
        
      } catch (error) {
        showError(error.message);
      }
    }

    function renderHeader(data) {
      qs('#addr').textContent = data.address || 'Property Report';
      const inspectionDate = data.inspection_date || data.created_at;
      if (inspectionDate) {
        qs('#date').textContent = 'Inspection Date: ' + new Date(inspectionDate).toLocaleDateString();
      }
    }

    function renderSummary(totals) {
      qs('#total').textContent = totals.total_photos || 0;
      qs('#crit').textContent = totals.critical_issues || 0;
      qs('#imp').textContent = totals.important_issues || 0;
    }

    function renderPhotos(photos) {
      const grid = qs('#grid'); 
      grid.innerHTML = '';
      
      for (const photo of photos) {
        const div = document.createElement('div');
        div.className = 'photo';
        div.innerHTML = `
          <img class="thumb" src="${photo.thumbnail_url || photo.url}" alt="">
          <div class="info">
            <div class="loc">${photo.location || 'Photo'}</div>
            <div class="badges">
              ${photo.is_critical ? '<span class="badge critical">Critical</span>' : ''}
              ${photo.is_important && !photo.is_critical ? '<span class="badge important">Important</span>' : ''}
            </div>
          </div>`;
        div.onclick = () => openModal(photo.original_url || photo.url || photo.thumbnail_url);
        grid.appendChild(div);
      }
    }

    function renderByLocation(photos) {
      const groups = {};
      for (const photo of photos) {
        const k = photo.location?.trim() || 'Unspecified';
        (groups[k] ||= []).push(photo);
      }
      const container = qs('#tab-location');
      container.innerHTML = '';
      for (const [loc, arr] of Object.entries(groups)) {
        const wrap = document.createElement('div');
        wrap.style.marginBottom = '1rem';
        wrap.innerHTML = `<h3 class="location-title">${loc}</h3>`;
        wrap.className = 'location-section';
        const grid = document.createElement('div');
        grid.className = 'photos';
        for (const photo of arr) {
          const ph = document.createElement('div');
          ph.className = 'photo';
          ph.innerHTML = `<img class="thumb" src="${photo.thumbnail_url || photo.url}" alt="">`;
          ph.onclick = () => openModal(photo.original_url || photo.url || photo.thumbnail_url);
          grid.appendChild(ph);
        }
        wrap.appendChild(grid);
        container.appendChild(wrap);
      }
    }

    function renderLists(photos) {
      const obs = qs('#list-ob'), iss = qs('#list-iss'), rec = qs('#list-rec');
      obs.innerHTML = iss.innerHTML = rec.innerHTML = '';

      for (const photo of photos) {
        for (const t of (photo.observations || [])) {
          const li = document.createElement('li'); 
          li.className = 'item';
          li.innerHTML = `<strong>${photo.location || 'Area'}:</strong> ${t}`;
          obs.appendChild(li);
        }
        for (const t of (photo.potential_issues || [])) {
          const li = document.createElement('li'); 
          li.className = 'item ' + (photo.is_critical ? 'critical' : photo.is_important ? 'important' : '');
          li.innerHTML = `<strong>${photo.location || 'Area'}:</strong> ${t}`;
          iss.appendChild(li);
        }
        for (const t of (photo.recommendations || [])) {
          const li = document.createElement('li'); 
          li.className = 'item ' + (photo.is_critical ? 'critical' : photo.is_important ? 'important' : '');
          li.innerHTML = `<strong>${photo.location || 'Area'}:</strong> ${t}`;
          rec.appendChild(li);
        }
      }
    }

    function wireDownloads() {
      const std = qs('#btn-std'), hq = qs('#btn-hq');
      std.onclick = () => pdfs?.standard && window.open(pdfs.standard, '_blank');
      
      // Disable HQ button for portal access (not exposed via API)
      hq.disabled = true;
      hq.textContent = 'High‑Quality PDF (Admin Only)';
    }

    function wireTabs() {
      qsa('.tabbar button').forEach(btn => {
        btn.onclick = () => {
          qsa('.tabbar button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const tab = btn.dataset.tab;
          qs('#tab-all').className = tab === 'all' ? '' : 'tab-content-hidden';
          qs('#tab-location').className = tab === 'location' ? '' : 'tab-content-hidden';
          qs('#tab-observations').className = tab === 'observations' ? '' : 'tab-content-hidden';
          qs('#tab-issues').className = tab === 'issues' ? '' : 'tab-content-hidden';
          qs('#tab-recs').className = tab === 'recs' ? '' : 'tab-content-hidden';
        };
      });
    }

    function wireModal() {
      const modal = qs('#modal'), img = qs('#img'), x = qs('#x');
      x.onclick = () => modal.classList.remove('show');
      modal.onclick = (e) => { if (e.target === modal) modal.classList.remove('show'); };
      document.addEventListener('keydown', e => { if (e.key === 'Escape') modal.classList.remove('show'); });
      window.openModal = (src) => { img.src = src; modal.classList.add('show'); };
    }
    
    function showError(message) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = `Error: ${message}`;
      errorEl.style.display = 'block';
      document.getElementById('grid').innerHTML = '';
    }

    load();
  </script>
</body>
</html>