<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Owner Portal - CheckMyRental</title>
  <style>
    /* Base + branding to match landing page */
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    
    body {
      margin: 0;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #f8f8f8;
      color: #1a1a1a;
      line-height: 1.6;
      transition: background-color 0.3s, color 0.3s;
      min-height: 100vh;
    }
    
    /* Dark mode gradient to match landing */
    body.dark-mode {
      background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
      color: #cbd5e1;
    }
    
    /* Starfield background (landing) */
    .stars { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      pointer-events: none; 
      z-index: 0; 
      opacity: 0; 
      transition: opacity 0.5s; 
    }
    
    body.dark-mode .stars { 
      opacity: 1; 
    }
    
    .star { 
      position: absolute; 
      background: white; 
      border-radius: 50%; 
      box-shadow: 0 0 10px rgba(255,255,255,0.5); 
      animation: twinkle 4s ease-in-out infinite; 
    }
    
    @keyframes twinkle { 
      0%, 100% { opacity: 0.2; transform: scale(0.8); } 
      50% { opacity: 1; transform: scale(1.2); } 
    }
    
    .shooting-star { 
      position: absolute; 
      width: 4px; 
      height: 4px; 
      background: white; 
      border-radius: 50%; 
      box-shadow: 0 0 10px 2px rgba(255,255,255,0.8); 
      opacity: 0; 
      animation: shoot 4s linear infinite; 
      z-index: 2; 
    }
    
    .shooting-star::before { 
      content: ''; 
      position: absolute; 
      top: 50%; 
      right: 100%; 
      transform: translateY(-50%); 
      width: 100px; 
      height: 1px; 
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), rgba(255,255,255,0.6)); 
      transform-origin: right center; 
      z-index: -1; 
    }
    
    @keyframes shoot { 
      0% { transform: translateX(-100px) translateY(0) rotate(45deg); opacity: 0; } 
      10% { opacity: 1; } 
      90% { opacity: 1; } 
      100% { transform: translateX(calc(100vw + 100px)) translateY(calc(100vh + 100px)) rotate(45deg); opacity: 0; } 
    }
    
    /* Header (landing) */
    .header { 
      position: fixed; 
      width: 100%; 
      top: 0; 
      background: white; 
      z-index: 1000; 
      box-shadow: 0 2px 20px rgba(0,0,0,0.05); 
      transition: background-color 0.3s, box-shadow 0.3s; 
    }
    
    body.dark-mode .header { 
      background: rgba(22, 27, 34, 0.95); 
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px); 
      box-shadow: 0 2px 20px rgba(0,0,0,0.5); 
      border-bottom: 1px solid rgba(56,68,89,0.3); 
    }
    
    .header-content { 
      max-width: 1600px; 
      margin: 0 auto; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 1rem 3rem; 
      height: 80px; 
    }
    
    .logo-container { 
      display: flex; 
      align-items: center; 
      gap: 0.5rem; 
    }
    
    .logo-icon { 
      position: relative; 
      width: 45px; 
      height: 45px; 
      flex-shrink: 0; 
    }
    
    .logo-house { 
      width: 35px; 
      height: 35px; 
      background: #2c3e50; 
      transform: rotate(45deg); 
      position: absolute; 
      top: 5px; 
      left: 5px; 
    }
    
    .logo-window { 
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      width: 12px; 
      height: 12px; 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      grid-template-rows: 1fr 1fr; 
      gap: 2px; 
    }
    
    .logo-window span { 
      background: white; 
      display: block; 
    }
    
    .logo-check { 
      position: absolute; 
      bottom: 0; 
      right: 0; 
      width: 20px; 
      height: 20px; 
      background: #e74c3c; 
      border-radius: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
    }
    
    .logo-check::after { 
      content: ''; 
      width: 8px; 
      height: 4px; 
      border: 2px solid white; 
      border-top: none; 
      border-right: none; 
      transform: rotate(-45deg) translateY(-1px); 
    }
    
    .logo-text { 
      font-size: 1.5rem; 
      font-weight: 300; 
      letter-spacing: -0.5px; 
      white-space: nowrap; 
    }
    
    .logo-text .check { 
      color: #1a1a1a; 
      transition: color 0.3s; 
    }
    
    body.dark-mode .logo-text .check { 
      color: #e0e0e0; 
    }
    
    .logo-text .my { 
      color: #1a1a1a; 
      font-weight: 600; 
      transition: color 0.3s; 
    }
    
    body.dark-mode .logo-text .my { 
      color: #e0e0e0; 
    }
    
    .logo-text .rental { 
      color: #e74c3c; 
      font-weight: 600; 
    }
    
    /* User menu styling to harmonize with landing nav */
    .user-menu { 
      display: flex; 
      align-items: center; 
      gap: 1.5rem; 
    }
    
    .user-menu #owner-name { 
      color: inherit; 
      opacity: 0.9;
      font-size: 1rem;
    }
    
    .user-menu button { 
      background: #e74c3c; 
      color: white; 
      padding: 0.6rem 1.5rem; 
      border-radius: 25px; 
      border: none; 
      cursor: pointer; 
      transition: all 0.3s;
      font-size: 1rem;
    }
    
    .user-menu button:hover { 
      background: #c0392b; 
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }
    
    /* Layout containers */
    .container { 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 0 16px; 
      position: relative; 
      z-index: 1; 
    }
    
    /* Main content area - properly positioned below header */
    main {
      margin-top: 80px;
      position: relative;
      z-index: 1;
    }
    
    /* Tabs bar */
    nav.main-tabs { 
      background: rgba(255,255,255,0.95); 
      border-bottom: 1px solid rgba(56,68,89,0.15); 
      position: sticky; 
      top: 80px; 
      z-index: 9; 
    }
    
    body.dark-mode nav.main-tabs { 
      background: rgba(22,27,34,0.95); 
      border-bottom-color: rgba(56,68,89,0.3); 
    }
    
    .tabs-wrapper { 
      display: flex; 
    }
    
    .main-tab { 
      flex: 1; 
      padding: 14px; 
      background: transparent; 
      color: #666; 
      border: 0; 
      border-bottom: 3px solid transparent; 
      cursor: pointer; 
      display: flex; 
      gap: 8px; 
      align-items: center; 
      justify-content: center;
      font-size: 1rem;
      transition: all 0.3s;
    }
    
    body.dark-mode .main-tab { 
      color: #94a3b8; 
    }
    
    .main-tab:hover {
      background: rgba(231, 76, 60, 0.05);
    }
    
    .main-tab.active { 
      border-bottom-color: #e74c3c; 
      color: #1a1a1a;
      background: transparent;
    }
    
    body.dark-mode .main-tab.active { 
      color: #fff; 
    }
    
    /* Content sections */
    .dashboard-section, 
    .properties-section, 
    .gallery-section { 
      padding: 3rem 0; 
    }
    
    .properties-section, 
    .gallery-section { 
      display: none; 
    }
    
    .properties-section.active, 
    .gallery-section.active { 
      display: block; 
    }
    
    /* Welcome heading */
    .welcome-heading {
      font-size: 2.5rem;
      font-weight: 200;
      margin-bottom: 2rem;
      color: #1a1a1a;
      letter-spacing: -0.5px;
    }
    
    body.dark-mode .welcome-heading {
      color: #f1f5f9;
    }
    
    .welcome-heading strong {
      font-weight: 600;
      color: #e74c3c;
    }
    
    /* Grid layouts */
    .properties-grid, 
    .gallery-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
      gap: 20px;
      margin-top: 2rem;
    }
    
    /* Report Section Styles */
    .report-section {
      margin-bottom: 2rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .report-section:last-child {
      border-bottom: none;
    }
    
    .issue-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .issue-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .inspection-btn {
      padding: 0.75rem 1rem;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 120px;
      text-align: center;
    }
    
    .inspection-btn:hover {
      border-color: #3b82f6;
      background: #f0f9ff;
    }
    
    .inspection-btn.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    /* Property cards */
    .property-card { 
      background: rgba(255,255,255,0.95); 
      border: 1px solid rgba(56,68,89,0.1); 
      border-radius: 12px; 
      padding: 1.5rem;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    body.dark-mode .property-card { 
      background: rgba(30,37,48,0.6); 
      border: 1px solid rgba(56,68,89,0.2);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
    }
    
    .property-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }
    
    body.dark-mode .property-card:hover {
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    
    /* Property filters */
    .properties-filters {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: rgba(255,255,255,0.5);
      border-radius: 12px;
    }
    
    body.dark-mode .properties-filters {
      background: rgba(30,37,48,0.3);
    }
    
    .properties-filters label {
      font-weight: 500;
      color: #666;
    }
    
    body.dark-mode .properties-filters label {
      color: #94a3b8;
    }
    
    .properties-filters input,
    .properties-filters select {
      padding: 0.6rem 1rem;
      border: 1px solid rgba(56,68,89,0.2);
      border-radius: 8px;
      background: white;
      font-size: 1rem;
    }
    
    body.dark-mode .properties-filters input,
    body.dark-mode .properties-filters select {
      background: rgba(17,22,31,0.6);
      color: #cbd5e1;
      border-color: rgba(56,68,89,0.4);
    }
    
    /* Inspection items */
    .inspection-item { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 12px; 
      border-radius: 8px; 
      background: rgba(0,0,0,0.03); 
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 0.5rem;
    }
    
    body.dark-mode .inspection-item { 
      background: rgba(0,0,0,0.2); 
    }
    
    .inspection-item:hover {
      background: rgba(231, 76, 60, 0.1);
    }
    
    .inspection-item:focus { 
      outline: 2px solid #e74c3c; 
      outline-offset: 2px; 
    }
    
    /* Gallery items */
    .gallery-item {
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(56,68,89,0.15);
      border-radius: 10px;
      overflow: hidden;
      transition: all 0.3s;
    }
    
    body.dark-mode .gallery-item {
      background: rgba(30,37,48,0.6);
      border: 1px solid rgba(56,68,89,0.2);
    }
    
    .gallery-image { 
      width: 100%; 
      height: 200px; 
      object-fit: cover; 
      background: #f8f9fa; 
    }
    
    .gallery-info { 
      padding: 12px; 
      font-size: 14px; 
      color: #666; 
    }
    
    body.dark-mode .gallery-info { 
      color: #94a3b8; 
    }
    
    /* Buttons */
    .view-btn, 
    .inspection-btn,
    .btn-back { 
      padding: 0.6rem 1.2rem; 
      background: rgba(255,255,255,0.9); 
      border: 1px solid rgba(56,68,89,0.2); 
      border-radius: 8px; 
      cursor: pointer; 
      transition: all 0.2s;
      font-size: 0.95rem;
    }
    
    .btn-back {
      background: white;
      border: 1px solid #e74c3c;
      color: #e74c3c;
      padding: 0.6rem 1.5rem;
    }
    
    .btn-back:hover {
      background: #e74c3c;
      color: white;
    }
    
    body.dark-mode .view-btn, 
    body.dark-mode .inspection-btn { 
      background: rgba(30,37,48,0.6); 
      color: #cbd5e1; 
    }
    
    .view-btn:hover, 
    .inspection-btn:hover { 
      background: rgba(231,76,60,0.1); 
      border-color: #e74c3c; 
    }
    
    .view-btn.active, 
    .inspection-btn.active { 
      background: #e74c3c; 
      color: white; 
      border-color: #e74c3c; 
    }
    
    /* Stats grid */
    #statsGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 2rem 0;
    }
    
    #statsGrid > div {
      padding: 1.5rem;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(56,68,89,0.15);
      border-radius: 12px;
      text-align: center;
    }
    
    body.dark-mode #statsGrid > div {
      background: rgba(30,37,48,0.6);
      border: 1px solid rgba(56,68,89,0.2);
    }
    
    /* Modal */
    .modal { 
      display: none; 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.9); 
      align-items: center; 
      justify-content: center; 
      padding: 16px; 
      z-index: 2000; 
    }
    
    .modal.active { 
      display: flex; 
    }
    
    .modal-content { 
      background: white; 
      border: 1px solid rgba(56,68,89,0.3); 
      border-radius: 12px; 
      max-width: 1000px; 
      width: 100%; 
      max-height: 90vh; 
      overflow: auto; 
      position: relative; 
    }
    
    body.dark-mode .modal-content {
      background: #1e2530;
      border-color: rgba(56,68,89,0.3);
    }
    
    .modal-close { 
      position: absolute; 
      top: 12px; 
      right: 12px; 
      width: 36px; 
      height: 36px; 
      border: 1px solid rgba(255,255,255,0.2); 
      background: rgba(255,255,255,0.1); 
      color: #1a1a1a; 
      border-radius: 50%; 
      font-size: 22px; 
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    body.dark-mode .modal-close {
      color: #fff;
    }
    
    .modal-close:hover {
      background: rgba(231, 76, 60, 0.2);
      border-color: #e74c3c;
    }
    
    /* Floating dark-mode toggle */
    .theme-toggle { 
      position: fixed; 
      bottom: 2rem; 
      right: 2rem; 
      width: 55px; 
      height: 55px; 
      border-radius: 50%; 
      background: white; 
      border: 2px solid #e74c3c; 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      transition: all 0.3s; 
      font-size: 1.4rem; 
      z-index: 1001; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
    }
    
    .theme-toggle:hover { 
      transform: scale(1.1) rotate(20deg); 
      box-shadow: 0 6px 30px rgba(231, 76, 60, 0.3); 
    }
    
    body.dark-mode .theme-toggle { 
      background: rgba(30, 37, 48, 0.95); 
      border-color: rgba(231, 76, 60, 0.6); 
      box-shadow: 0 4px 20px rgba(0,0,0,0.3); 
    }
    
    /* Utility classes */
    .visually-hidden { 
      position: absolute; 
      width: 1px; 
      height: 1px; 
      padding: 0; 
      margin: -1px; 
      overflow: hidden; 
      clip: rect(0,0,0,0); 
      border: 0; 
    }
    
    /* Photo gallery styles */
    .photo-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .photo-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    
    body.dark-mode .photo-card {
      background: rgba(30,37,48,0.6) !important;
      border-color: rgba(56,68,89,0.3) !important;
    }
    
    /* Modal navigation buttons */
    .modal-nav:hover {
      background: rgba(0,0,0,0.7) !important;
      transform: scale(1.1);
    }
    
    /* Search input in dark mode */
    body.dark-mode #gallerySearch {
      background: rgba(17,22,31,0.6);
      color: #cbd5e1;
      border-color: rgba(56,68,89,0.4);
    }
    
    /* Photo gallery grid dark mode */
    body.dark-mode #photoGalleryView {
      color: #cbd5e1;
    }
    
    body.dark-mode #reportContent {
      background: rgba(30,37,48,0.6) !important;
      color: #cbd5e1;
    }
    
    body.dark-mode .issue-card {
      background: rgba(30,37,48,0.8) !important;
      border-color: rgba(56,68,89,0.3) !important;
    }
    
    body.dark-mode #statsGrid > div {
      background: rgba(30,37,48,0.6) !important;
    }
    
    body.dark-mode #reportActionsBar {
      background: rgba(30,37,48,0.6) !important;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3) !important;
    }
    
    body.dark-mode #reportActionsBar label {
      color: #94a3b8;
    }
    
    body.dark-mode #severityFilter {
      background: rgba(17,22,31,0.6);
      color: #cbd5e1;
      border-color: rgba(56,68,89,0.4);
    }
    
    body.dark-mode #emptyState {
      background: rgba(30,37,48,0.6) !important;
      color: #cbd5e1;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .header-content {
        padding: 1rem;
      }
      
      .properties-grid, 
      .gallery-grid,
      #photoGalleryGrid {
        grid-template-columns: 1fr;
      }
      
      .welcome-heading {
        font-size: 1.8rem;
      }
      
      .main-tab {
        font-size: 0.9rem;
        padding: 10px 8px;
      }
      
      .user-menu #owner-name {
        display: none;
      }
      
      .modal-content {
        max-width: 95% !important;
      }
      
      #gallerySearch {
        width: 150px !important;
      }
    }
  </style>
</head>
<body>
  <a href="#dashboardSection" class="visually-hidden">Skip to content</a>
  
  <!-- Starfield for dark mode, matching landing -->
  <div class="stars" id="stars"></div>
  
  <!-- Floating Dark Mode Toggle -->
  <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle" title="Toggle dark mode" aria-label="Toggle dark mode">
    <span id="theme-icon">🌙</span>
  </button>
  
  <header class="header">
    <div class="header-content">
      <div class="logo-container">
        <div class="logo-icon">
          <div class="logo-house">
            <div class="logo-window">
              <span></span>
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
          <div class="logo-check"></div>
        </div>
        <div class="logo-text">
          <span class="check">Check</span><span class="my">My</span><span class="rental">Rental</span>
        </div>
      </div>
      <div class="user-menu">
        <div id="owner-name">Loading...</div>
        <button type="button" onclick="handleLogout()">Sign Out</button>
      </div>
    </div>
  </header>
  
  <main id="main">
    <nav class="main-tabs" aria-label="Primary">
      <div class="container">
        <div class="tabs-wrapper" role="tablist">
          <button id="tab-dashboard" type="button" class="main-tab active" role="tab" aria-selected="true" aria-controls="dashboardSection" data-tab="dashboard">
            <span aria-hidden="true">📊</span>
            <span>Dashboard</span>
          </button>
          <button id="tab-properties" type="button" class="main-tab" role="tab" aria-selected="false" aria-controls="propertiesSection" data-tab="properties">
            <span aria-hidden="true">🏠</span>
            <span>All Properties</span>
            <span id="properties-count" style="margin-left: 6px; background: rgba(231,76,60,0.2); color: #e74c3c; padding: 2px 8px; border-radius: 10px; font-size: 0.85rem;">0</span>
          </button>
          <button id="tab-gallery" type="button" class="main-tab" role="tab" aria-selected="false" aria-controls="gallerySection" data-tab="gallery">
            <span aria-hidden="true">📸</span>
            <span id="galleryTabText">Property Gallery</span>
          </button>
        </div>
      </div>
    </nav>
    
    <section id="dashboardSection" class="dashboard-section" role="tabpanel" aria-labelledby="tab-dashboard">
      <div class="container">
        <h1 class="welcome-heading">Welcome back, <strong id="welcome-name">Owner</strong></h1>
        <h2 style="font-size: 1.3rem; font-weight: 300; color: #666; margin-bottom: 2rem;">Recent Properties</h2>
        <div id="recentPropertiesGrid" class="properties-grid"></div>
      </div>
    </section>
    
    <section id="propertiesSection" class="properties-section" role="tabpanel" aria-labelledby="tab-properties" hidden>
      <div class="container">
        <h2 class="visually-hidden" id="propertiesHeading">All Properties</h2>
        <div class="properties-filters">
          <label for="propertySearch">Search:</label>
          <input type="text" id="propertySearch" placeholder="Address or property name..." aria-label="Search properties" />
          <label for="propertyType">Type:</label>
          <select id="propertyType" aria-label="Filter by property type">
            <option value="all">All Types</option>
            <option value="single">Single Family</option>
            <option value="condo">Condo</option>
            <option value="duplex">Duplex</option>
            <option value="commercial">Commercial</option>
          </select>
        </div>
        <div id="propertiesGrid" class="properties-grid"></div>
      </div>
    </section>
    
    <section id="gallerySection" class="gallery-section" role="tabpanel" aria-labelledby="tab-gallery" hidden>
      <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 2rem;">
          <div>
            <div id="currentPropertyTitle" style="font-size: 1.8rem; font-weight: 600; color: #1a1a1a;">Select a Property</div>
            <div id="currentPropertyAddress" style="color: #666; margin-top: 0.25rem;"></div>
          </div>
          <button type="button" onclick="showProperties()" class="btn-back">← Back to All Properties</button>
        </div>
        
        <div id="inspectionSelector" style="display: flex; gap: 0.75rem; overflow-x: auto; padding: 0.75rem 0; margin-bottom: 2rem;"></div>
        
        <!-- Report Actions Bar -->
        <div id="reportActionsBar" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; margin-bottom: 1.5rem; background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          <button type="button" onclick="toggleGalleryView()" class="btn" style="background: #8b5cf6; color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer;">
            <span id="viewToggleIcon">📸</span> <span id="viewToggleText">Photo Gallery</span>
          </button>
          <button type="button" onclick="downloadCurrentPdf()" class="btn" style="background: #3b82f6; color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer;">
            📄 Download PDF
          </button>
          <div style="margin-left: auto; display: flex; gap: 0.5rem; align-items: center;">
            <input type="text" id="gallerySearch" placeholder="Search photos..." style="padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; width: 200px;" onkeyup="filterGalleryItems()">
            <label for="severityFilter">Filter:</label>
            <select id="severityFilter" aria-label="Filter by severity" onchange="filterReportIssues()" style="padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
              <option value="all">All Issues</option>
              <option value="critical">Critical Only</option>
              <option value="important">Important Only</option>
              <option value="minor">Minor Only</option>
            </select>
          </div>
        </div>
        
        <!-- Report Summary Stats -->
        <div id="statsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;"></div>
        
        <!-- Photo Gallery View -->
        <div id="photoGalleryView" style="display: none;">
          <div id="photoGalleryGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;"></div>
        </div>
        
        <!-- Report Content Area -->
        <div id="reportContent" style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          <div id="reportSections"></div>
        </div>
        
        <div id="emptyState" style="display: none; text-align: center; padding: 3rem; background: white; border-radius: 8px;">
          <div aria-hidden="true" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;">📋</div>
          <div style="font-size: 1.2rem; color: #666;">Select a property and inspection to view the report</div>
        </div>
      </div>
    </section>
  </main>
  
  <div id="photoModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content" style="max-width: 1200px;">
      <h2 id="modalTitle" class="visually-hidden">Photo details</h2>
      <button type="button" aria-label="Close" class="modal-close" onclick="closeModal()">×</button>
      
      <!-- Navigation arrows for modal -->
      <button type="button" class="modal-nav modal-nav-prev" onclick="navigateModal(-1)" aria-label="Previous photo" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; padding: 1rem; border-radius: 8px; cursor: pointer; font-size: 1.5rem; z-index: 10;">‹</button>
      <button type="button" class="modal-nav modal-nav-next" onclick="navigateModal(1)" aria-label="Next photo" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; padding: 1rem; border-radius: 8px; cursor: pointer; font-size: 1.5rem; z-index: 10;">›</button>
      
      <div style="display: flex; flex-direction: column; height: 100%;">
        <img id="modalImage" alt="" style="width: 100%; max-height: 60vh; object-fit: contain; background: #f8f9fa;" />
        <div id="modalInfo" style="padding: 1.5rem; flex: 1; overflow-y: auto;"></div>
      </div>
    </div>
  </div>
  
  <script>
    let propertiesData = [];
    let currentProperty = null;
    let currentInspection = null;
    let currentReportData = null;
    let currentView = 'report';  // 'report' or 'gallery'
    let galleryPhotos = [];
    let currentPhotoIndex = 0;
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const API_BASE = window.location.origin;
    let dashboardData = null;
    let allProperties = [];
    
    document.addEventListener('DOMContentLoaded', () => {
      if (!token) {
        alert('Error: No access token provided.');
        return;
      }
      loadDashboardData();
      setupEventListeners();
    });
    
    function handleLogout() {
      if (confirm('Are you sure you want to sign out?')) {
        location.href = '/static/landing.html';
      }
    }
    
    async function loadDashboardData() {
      try {
        const res = await fetch(`${API_BASE}/api/portal/dashboard?portal_token=${encodeURIComponent(token)}`);
        if (!res.ok) {
          if (res.status === 401) throw new Error('Invalid or expired access token');
          if (res.status === 404) throw new Error('Property not found');
          throw new Error('Failed to load dashboard');
        }
        dashboardData = await res.json();
        renderDashboard();
      } catch(e) {
        alert(`Error: ${e.message}`);
      }
    }
    
    function renderDashboard() {
      const ownerName = dashboardData.owner?.name || 'Owner';
      document.getElementById('owner-name').textContent = ownerName;
      document.getElementById('welcome-name').textContent = ownerName;
      
      allProperties = dashboardData.properties || [];
      propertiesData = allProperties.map(p => ({
        id: p.id,
        name: p.label || (p.address || '').split(',')[0] || 'Property',
        address: p.address || '',
        type: p.type || 'single',
        inspections: (p.reports || []).map(r => ({
          date: r.date || r.created_at,
          quarter: getQuarter(r.date || r.created_at),
          photos: r.photos || 0,
          critical: r.criticalIssues || r.critical || 0,
          important: r.importantIssues || r.important || 0,
          minor: r.minor || 0,
          report_id: r.id || r.report_id,
          hasPdf: r.hasPdf || false,
          hasInteractiveView: r.hasInteractiveView || false,
          inspector: r.inspector || 'Inspector'
        }))
      }));
      
      document.getElementById('properties-count').textContent = dashboardData.totals?.properties || 0;
      loadProperties();
      loadRecentProperties();
    }
    
    function loadRecentProperties() {
      const grid = document.getElementById('recentPropertiesGrid');
      grid.innerHTML = '';
      
      if (propertiesData.length === 0) {
        grid.innerHTML = '<p style="color: #94a3b8;">No properties found</p>';
        return;
      }
      
      propertiesData.slice(0, 3).forEach(p => grid.appendChild(createPropertyCard(p)));
    }
    
    function createPropertyCard(property) {
      const div = document.createElement('div');
      div.className = 'property-card';
      div.dataset.type = property.type || 'single';
      div.dataset.address = (property.address || '').toLowerCase();
      
      const hasInspections = property.inspections && property.inspections.length > 0;
      
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
          <div>
            <div style="font-weight: 600; font-size: 1.1rem; color: #1a1a1a;">${property.name}</div>
            <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">${property.address}</div>
          </div>
          <div style="background: rgba(231,76,60,0.1); color: #e74c3c; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; font-weight: 500;">
            ${(property.type || 'single').replace(/\b\w/g, c => c.toUpperCase())}
          </div>
        </div>
        ${hasInspections ? `
          <div>
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.75rem;">
              ${property.inspections.length} Inspection${property.inspections.length !== 1 ? 's' : ''}
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
              ${property.inspections.slice(0, 3).map(i => `
                <div class="inspection-item" style="padding: 0.75rem; border: 1px solid #e5e5e5; border-radius: 8px; cursor: pointer; transition: all 0.2s;" 
                     onclick="event.stopPropagation(); viewReport('${i.report_id}')">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <div>
                      <div style="font-size: 0.95rem; font-weight: 500;">${new Date(i.date).toLocaleDateString()}</div>
                      <div style="font-size: 0.85rem; color: #94a3b8;">${i.inspector}</div>
                    </div>
                    <div style="display: flex; gap: 0.25rem;">
                      ${i.hasPdf ? `<button onclick="event.stopPropagation(); downloadPdf('${i.report_id}')" title="Download PDF" style="padding: 4px 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">📄 PDF</button>` : ''}
                      <button onclick="event.stopPropagation(); viewReport('${i.report_id}')" title="View Gallery & Report" style="padding: 4px 8px; background: #8b5cf6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">📸 Gallery</button>
                    </div>
                  </div>
                  <div style="display: flex; gap: 0.5rem;">
                    ${i.critical > 0 ? `<span style="padding: 3px 8px; border-radius: 10px; background: rgba(231,76,60,0.2); color: #e74c3c; font-size: 0.8rem;">${i.critical} Critical</span>` : ''}
                    ${i.important > 0 ? `<span style="padding: 3px 8px; border-radius: 10px; background: rgba(243,156,18,0.2); color: #f39c12; font-size: 0.8rem;">${i.important} Important</span>` : ''}
                    ${i.photos > 0 ? `<span style="padding: 3px 8px; border-radius: 10px; background: rgba(56,68,89,0.2); color: #38445a; font-size: 0.8rem;">${i.photos} Photos</span>` : ''}
                  </div>
                </div>
              `).join('')}
            </div>
            <button onclick="event.stopPropagation(); openPropertyGallery('${property.id}')" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
              📸 View All Photos & Reports
            </button>
          </div>
        ` : `<div style="font-size: 0.9rem; color: #94a3b8;">No inspections available</div>`}
      `;
      
      return div;
    }
    
    function loadProperties() {
      const grid = document.getElementById('propertiesGrid');
      grid.innerHTML = '';
      propertiesData.forEach(p => grid.appendChild(createPropertyCard(p)));
    }
    
    function filterProperties() {
      const searchTerm = (document.getElementById('propertySearch').value || '').toLowerCase();
      const propertyType = document.getElementById('propertyType').value;
      
      document.querySelectorAll('.property-card').forEach(card => {
        let show = true;
        if (searchTerm && !card.dataset.address.includes(searchTerm)) show = false;
        if (propertyType !== 'all' && card.dataset.type !== propertyType) show = false;
        card.style.display = show ? 'block' : 'none';
      });
    }
    
    async function openPropertyGallery(propertyId, inspectionDate) {
      const property = propertiesData.find(p => p.id === propertyId);
      if (!property) return;
      
      currentProperty = property;
      
      // If we have an inspection, load its report
      if (property.inspections && property.inspections.length > 0) {
        const inspection = inspectionDate 
          ? property.inspections.find(i => i.date === inspectionDate) 
          : property.inspections[0];
        
        if (inspection && inspection.report_id) {
          // Load the report data
          await viewReport(inspection.report_id);
        }
      } else {
        // Show empty state
        showTab('gallery');
        document.getElementById('currentPropertyTitle').textContent = property.name;
        document.getElementById('currentPropertyAddress').textContent = property.address;
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('reportContent').style.display = 'none';
      }
    }
    
    function selectInspection(date) {
      currentInspection = currentProperty.inspections.find(i => i.date === date);
      document.querySelectorAll('.inspection-btn').forEach(b => 
        b.classList.toggle('active', b.textContent.includes(new Date(date).toLocaleDateString()))
      );
      loadGallery();
    }
    
    async function loadGallery() {
      const empty = document.getElementById('emptyState');
      const container = document.getElementById('galleryContainer');
      const stats = document.getElementById('statsGrid');
      
      if (!currentInspection) {
        empty.style.display = 'block';
        container.innerHTML = '';
        stats.innerHTML = '';
        return;
      }
      
      empty.style.display = 'none';
      
      stats.innerHTML = `
        <div>
          <div style="font-size: 2rem; font-weight: 700; color: #1a1a1a;">${currentInspection.photos}</div>
          <div style="font-size: 0.9rem; color: #666;">Total Photos</div>
        </div>
        <div>
          <div style="font-size: 2rem; font-weight: 700; color: #e74c3c;">${currentInspection.critical || 0}</div>
          <div style="font-size: 0.9rem; color: #666;">Critical Issues</div>
        </div>
        <div>
          <div style="font-size: 2rem; font-weight: 700; color: #f39c12;">${currentInspection.important || 0}</div>
          <div style="font-size: 0.9rem; color: #666;">Important Issues</div>
        </div>
        <div>
          <div style="font-size: 2rem; font-weight: 700; color: #27ae60;">${currentInspection.minor || 0}</div>
          <div style="font-size: 0.9rem; color: #666;">Minor Issues</div>
        </div>
      `;
      
      container.innerHTML = '';
      
      if (currentInspection.items && currentInspection.items.length > 0) {
        currentInspection.items.forEach((item, idx) => {
          const severity = getSeverityLevel(item.severity);
          const photoUrl = item.photo_url || `/api/reports/${currentInspection.report_dir_name}/photos/photo_${String(idx + 1).padStart(3, '0')}.jpg`;
          
          const el = document.createElement('div');
          el.className = 'gallery-item';
          el.style.cursor = 'pointer';
          el.onclick = () => showPhotoModal(item, idx);
          
          el.innerHTML = `
            <img class="gallery-image" src="${photoUrl}" alt="${item.location || ('Photo ' + (idx + 1))}" 
                 onerror="this.src='/static/placeholder.jpg'; this.onerror=null;" />
            <div class="gallery-info">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="font-weight: 500;">${item.location || ('Photo ' + (idx + 1))}</span>
                <span style="padding: 2px 8px; border-radius: 6px; border: 1px solid rgba(56,68,89,0.2); font-size: 0.8rem; text-transform: uppercase;">
                  ${severity}
                </span>
              </div>
              <div style="font-size: 0.9rem; color: #94a3b8;">${item.observations || 'Click to view details'}</div>
            </div>
          `;
          
          container.appendChild(el);
        });
      } else {
        for (let i = 1; i <= currentInspection.photos; i++) {
          const el = document.createElement('div');
          el.className = 'gallery-item';
          el.innerHTML = `
            <img class="gallery-image" src="/api/reports/${currentInspection.report_id}/photos/photo_${String(i).padStart(3, '0')}.jpg" alt="Photo ${i}" />
            <div class="gallery-info">
              <div>Photo ${i}</div>
              <div style="font-size: 0.9rem; color: #94a3b8;">Click to view details</div>
            </div>
          `;
          container.appendChild(el);
        }
      }
    }
    
    function getSeverityLevel(s) {
      if (!s) return 'none';
      s = String(s).toLowerCase();
      if (s.includes('critical') || s.includes('high')) return 'critical';
      if (s.includes('important') || s.includes('medium')) return 'important';
      if (s.includes('minor') || s.includes('low')) return 'minor';
      return 'none';
    }
    
    function showPhotoModal(item, index) {
      const html = `
        <h3 style="color: #e74c3c; margin-bottom: 1rem;">Observations</h3>
        <p style="margin-bottom: 1.5rem;">${item.observations || 'No observations recorded'}</p>
        
        <h3 style="color: #e74c3c; margin-bottom: 1rem;">Potential Issues</h3>
        <ul style="margin-bottom: 1.5rem;">
          ${item.potential_issues ? item.potential_issues.map(i => `<li>${i}</li>`).join('') : '<li>No issues identified</li>'}
        </ul>
        
        <h3 style="color: #e74c3c; margin-bottom: 1rem;">Recommendations</h3>
        <ul>
          ${item.recommendations ? item.recommendations.map(r => `<li>${r}</li>`).join('') : '<li>No recommendations</li>'}
        </ul>
      `;
      
      openModal(
        item.photo_url || '/static/placeholder.jpg',
        item.location || ('Photo ' + (index + 1)),
        html
      );
    }
    
    function openModal(src, alt, html) {
      const modal = document.getElementById('photoModal');
      const img = document.getElementById('modalImage');
      const info = document.getElementById('modalInfo');
      
      img.src = src;
      img.alt = alt || 'Selected photo';
      info.innerHTML = html || '';
      modal.classList.add('active');
    }
    
    function closeModal() {
      document.getElementById('photoModal').classList.remove('active');
    }
    
    function getQuarter(d) {
      const dt = new Date(d);
      return `Q${Math.floor(dt.getMonth() / 3) + 1} ${dt.getFullYear()}`;
    }
    
    function switchView(v) {
      currentView = v;
      document.querySelectorAll('.view-btn').forEach(b => 
        b.classList.toggle('active', b.dataset.view === v)
      );
      
      const container = document.getElementById('galleryContainer');
      container.style.display = 'grid';
      container.style.gridTemplateColumns = v === 'grid' 
        ? 'repeat(auto-fill, minmax(300px, 1fr))' 
        : '1fr';
    }
    
    function showTab(t) {
      document.getElementById('dashboardSection').hidden = (t !== 'dashboard');
      document.getElementById('propertiesSection').hidden = (t !== 'properties');
      document.getElementById('gallerySection').hidden = (t !== 'gallery');
      
      document.querySelectorAll('.main-tab').forEach(x => x.classList.remove('active'));
      const btn = document.querySelector(`[data-tab="${t}"]`);
      if (btn) btn.classList.add('active');
    }
    
    function showProperties() {
      showTab('properties');
    }
    
    function setupEventListeners() {
      document.querySelectorAll('.main-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          showTab(tabName);
          
          // If gallery tab clicked without a property selected, show empty state
          if (tabName === 'gallery' && !currentProperty) {
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('reportContent').style.display = 'none';
            document.getElementById('statsGrid').innerHTML = '';
          }
        });
      });
      
      document.getElementById('propertySearch')?.addEventListener('input', filterProperties);
      document.getElementById('propertyType')?.addEventListener('change', filterProperties);
    }
  </script>
  
  <script>
    // THEME + STARFIELD copied from landing page for consistent branding
    function initTheme() {
      const theme = localStorage.getItem('theme');
      const isDark = theme === 'dark' || (!theme && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
      document.body.classList.toggle('dark-mode', !!isDark);
      const icon = document.getElementById('theme-icon');
      if (icon) icon.textContent = isDark ? '☀️' : '🌙';
    }
    
    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      const icon = document.getElementById('theme-icon');
      if (icon) icon.textContent = isDark ? '☀️' : '🌙';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }
    
    function generateStars() {
      const starsContainer = document.getElementById('stars');
      if (!starsContainer) return;
      starsContainer.innerHTML = '';
      
      for (let i = 0; i < 150; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDelay = Math.random() * 3 + 's';
        star.style.animationDuration = (3 + Math.random() * 2) + 's';
        
        const size = Math.random() * 3;
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.opacity = Math.random() * 0.8 + 0.2;
        
        starsContainer.appendChild(star);
      }
      
      function createShootingStar() {
        const shootingStar = document.createElement('div');
        shootingStar.className = 'shooting-star';
        
        if (Math.random() > 0.5) {
          shootingStar.style.left = '-100px';
          shootingStar.style.top = Math.random() * 30 + '%';
        } else {
          shootingStar.style.left = Math.random() * 30 + '%';
          shootingStar.style.top = '-100px';
        }
        
        shootingStar.style.animationDelay = '0s';
        shootingStar.style.animationDuration = (3 + Math.random() * 2) + 's';
        starsContainer.appendChild(shootingStar);
        
        setTimeout(() => shootingStar.remove(), 5000);
      }
      
      setInterval(createShootingStar, 3000 + Math.random() * 5000);
    }
    
    // PDF Download function
    async function downloadPdf(reportId) {
      try {
        const pdfUrl = `${API_BASE}/api/portal/report/${reportId}/pdf?portal_token=${encodeURIComponent(token)}`;
        
        // Create a temporary link and trigger download
        const link = document.createElement('a');
        link.href = pdfUrl;
        link.download = `inspection_report_${reportId}.pdf`;
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (error) {
        console.error('Error downloading PDF:', error);
        alert('Failed to download PDF. Please try again.');
      }
    }
    
    // View Interactive Report function - now loads in gallery section
    async function viewReport(reportId) {
      try {
        const property = propertiesData.find(p => 
          p.inspections.some(i => i.report_id === reportId)
        );
        if (property) {
          const inspection = property.inspections.find(i => i.report_id === reportId);
          currentProperty = property;
          currentInspection = inspection;
          
          // Switch to gallery tab and load report
          showTab('gallery');
          await loadReportData(reportId);
        }
      } catch (error) {
        console.error('Error loading report:', error);
        alert('Failed to load report. Please try again.');
      }
    }
    
    // Load report data into gallery view
    async function loadReportData(reportId) {
      try {
        const response = await fetch(`${API_BASE}/api/portal/report/${reportId}?portal_token=${encodeURIComponent(token)}`);
        if (!response.ok) throw new Error('Failed to load report');
        
        const data = await response.json();
        currentReportData = data;
        
        // Update header
        document.getElementById('currentPropertyTitle').textContent = currentProperty.name;
        document.getElementById('currentPropertyAddress').textContent = currentProperty.address;
        document.getElementById('galleryTabText').textContent = `Report: ${currentProperty.name}`;
        
        // Show inspection selector
        const selector = document.getElementById('inspectionSelector');
        selector.innerHTML = currentProperty.inspections.map(i => `
          <button type="button" class="inspection-btn ${i.report_id === reportId ? 'active' : ''}" 
                  onclick="viewReport('${i.report_id}')">
            ${new Date(i.date).toLocaleDateString()}
            <br>
            <small style="font-size: 0.8rem; opacity: 0.8;">
              ${i.critical} critical, ${i.important} important
            </small>
          </button>
        `).join('');
        
        // Display stats
        const statsGrid = document.getElementById('statsGrid');
        statsGrid.innerHTML = `
          <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #dc2626;">${data.metadata?.critical_count || 0}</div>
            <div style="color: #991b1b; font-size: 0.9rem;">Critical Issues</div>
          </div>
          <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #d97706;">${data.metadata?.important_count || 0}</div>
            <div style="color: #92400e; font-size: 0.9rem;">Important Issues</div>
          </div>
          <div style="background: #dbeafe; padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #2563eb;">${data.report?.sections?.length || 0}</div>
            <div style="color: #1e3a8a; font-size: 0.9rem;">Sections Inspected</div>
          </div>
          <div style="background: #d1fae5; padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #10b981;">✓</div>
            <div style="color: #065f46; font-size: 0.9rem;">Completed</div>
          </div>
        `;
        
        // Display report sections
        displayReportSections(data.report);
        
        // Hide empty state
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('reportContent').style.display = 'block';
        
      } catch (error) {
        console.error('Error loading report data:', error);
        document.getElementById('reportSections').innerHTML = `
          <div style="color: #dc2626; padding: 1rem; background: #fee2e2; border-radius: 6px;">
            Failed to load report data: ${error.message}
          </div>
        `;
      }
    }
    
    // Display report sections with issues
    function displayReportSections(reportData) {
      const container = document.getElementById('reportSections');
      
      // Prepare photo gallery data
      galleryPhotos = [];
      
      if (!reportData || !reportData.sections) {
        container.innerHTML = `
          <div style="padding: 2rem; text-align: center; color: #6b7280;">
            ${reportData?.summary || 'No detailed report data available. Please download the PDF for the full report.'}
          </div>
        `;
        return;
      }
      
      // Extract all photos from report for gallery view
      reportData.sections.forEach((section, sectionIndex) => {
        if (section.issues && section.issues.length > 0) {
          section.issues.forEach((issue, issueIndex) => {
            if (issue.images && issue.images.length > 0) {
              issue.images.forEach((img, imgIndex) => {
                galleryPhotos.push({
                  url: img.url || img,
                  section: section.name || section.title || `Section ${sectionIndex + 1}`,
                  location: section.location || '',
                  issue: issue.title || issue.name || 'Issue',
                  severity: issue.severity || 'minor',
                  description: issue.description || issue.details || '',
                  index: galleryPhotos.length
                });
              });
            }
          });
        }
        
        // Also add any section-level photos
        if (section.photos && section.photos.length > 0) {
          section.photos.forEach(photo => {
            galleryPhotos.push({
              url: photo.url || photo,
              section: section.name || section.title || `Section ${sectionIndex + 1}`,
              location: section.location || photo.location || '',
              issue: photo.caption || '',
              severity: 'info',
              description: photo.description || '',
              index: galleryPhotos.length
            });
          });
        }
      });
      
      container.innerHTML = reportData.sections.map((section, index) => `
        <div class="report-section" data-section="${section.name || index}" style="margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid #e5e7eb;">
          <h3 style="font-size: 1.3rem; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">
            ${section.name || section.title || `Section ${index + 1}`}
          </h3>
          ${section.location ? `<div style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem;">Location: ${section.location}</div>` : ''}
          
          <div class="issues-list">
            ${section.issues && section.issues.length > 0 ? section.issues.map(issue => `
              <div class="issue-card" data-severity="${issue.severity}" data-searchable="${(issue.title + ' ' + issue.description).toLowerCase()}" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #fafafa;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                  <div style="font-weight: 600; color: #374151;">${issue.title || issue.name || 'Issue'}</div>
                  <span class="severity-badge" style="
                    padding: 4px 12px; 
                    border-radius: 12px; 
                    font-size: 0.75rem; 
                    font-weight: 600;
                    ${issue.severity === 'critical' ? 'background: #fee2e2; color: #dc2626;' : 
                      issue.severity === 'important' ? 'background: #fef3c7; color: #d97706;' : 
                      'background: #dbeafe; color: #2563eb;'}
                  ">
                    ${(issue.severity || 'minor').toUpperCase()}
                  </span>
                </div>
                <div style="color: #4b5563; line-height: 1.6;">${issue.description || issue.details || ''}</div>
                ${issue.images && issue.images.length > 0 ? `
                  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
                    ${issue.images.map((img, imgIdx) => {
                      const photoIndex = galleryPhotos.findIndex(p => p.url === (img.url || img));
                      return `
                        <img src="${img.url || img}" alt="${issue.title}" 
                             style="width: 120px; height: 80px; object-fit: cover; border-radius: 6px; cursor: pointer;"
                             onclick="openPhotoFromGallery(${photoIndex})">
                      `;
                    }).join('')}
                  </div>
                ` : ''}
              </div>
            `).join('') : '<div style="color: #6b7280; padding: 1rem;">No issues found in this section.</div>'}
          </div>
        </div>
      `).join('');
      
      // Update photo gallery view
      updatePhotoGallery();
    }
    
    // Filter report issues by severity
    function filterReportIssues() {
      filterGalleryItems();
    }
    
    // Toggle between gallery and report view
    function toggleGalleryView() {
      currentView = currentView === 'gallery' ? 'report' : 'gallery';
      const galleryView = document.getElementById('photoGalleryView');
      const reportView = document.getElementById('reportContent');
      const toggleIcon = document.getElementById('viewToggleIcon');
      const toggleText = document.getElementById('viewToggleText');
      
      if (currentView === 'gallery') {
        galleryView.style.display = 'block';
        reportView.style.display = 'none';
        toggleIcon.textContent = '📋';
        toggleText.textContent = 'Report View';
        updatePhotoGallery();
      } else {
        galleryView.style.display = 'none';
        reportView.style.display = 'block';
        toggleIcon.textContent = '📸';
        toggleText.textContent = 'Photo Gallery';
      }
    }
    
    // Update photo gallery grid
    function updatePhotoGallery() {
      const grid = document.getElementById('photoGalleryGrid');
      
      if (galleryPhotos.length === 0) {
        grid.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 2rem;">No photos available for this inspection.</div>';
        return;
      }
      
      grid.innerHTML = galleryPhotos.map((photo, index) => `
        <div class="photo-card" data-index="${index}" data-severity="${photo.severity}" data-searchable="${(photo.section + ' ' + photo.issue + ' ' + photo.description).toLowerCase()}" 
             style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; cursor: pointer; transition: all 0.2s;"
             onclick="openPhotoFromGallery(${index})">
          <img src="${photo.url}" alt="${photo.issue}" style="width: 100%; height: 200px; object-fit: cover;" 
               onerror="this.src='/static/placeholder.jpg'; this.onerror=null;">
          <div style="padding: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
              <div style="font-weight: 600; color: #374151; font-size: 0.9rem;">${photo.section}</div>
              ${photo.severity !== 'info' ? `
                <span style="padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600;
                  ${photo.severity === 'critical' ? 'background: #fee2e2; color: #dc2626;' : 
                    photo.severity === 'important' ? 'background: #fef3c7; color: #d97706;' : 
                    'background: #dbeafe; color: #2563eb;'}">
                  ${photo.severity.toUpperCase()}
                </span>
              ` : ''}
            </div>
            <div style="color: #6b7280; font-size: 0.85rem; line-height: 1.4;">
              ${photo.issue || 'View Details'}
            </div>
            ${photo.location ? `<div style="color: #94a3b8; font-size: 0.8rem; margin-top: 0.25rem;">📍 ${photo.location}</div>` : ''}
          </div>
        </div>
      `).join('');
    }
    
    // Open photo from gallery
    function openPhotoFromGallery(index) {
      if (index < 0 || index >= galleryPhotos.length) return;
      
      currentPhotoIndex = index;
      const photo = galleryPhotos[index];
      
      const modal = document.getElementById('photoModal');
      const img = document.getElementById('modalImage');
      const info = document.getElementById('modalInfo');
      
      img.src = photo.url;
      img.alt = photo.issue || 'Inspection photo';
      
      info.innerHTML = `
        <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem; margin-bottom: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <h3 style="font-size: 1.2rem; font-weight: 600; color: #1f2937; margin: 0;">${photo.section}</h3>
            ${photo.severity !== 'info' ? `
              <span style="padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;
                ${photo.severity === 'critical' ? 'background: #fee2e2; color: #dc2626;' : 
                  photo.severity === 'important' ? 'background: #fef3c7; color: #d97706;' : 
                  'background: #dbeafe; color: #2563eb;'}">
                ${photo.severity.toUpperCase()}
              </span>
            ` : ''}
          </div>
          ${photo.location ? `<div style="color: #6b7280; margin-top: 0.5rem;">📍 Location: ${photo.location}</div>` : ''}
        </div>
        
        ${photo.issue ? `
          <div style="margin-bottom: 1rem;">
            <h4 style="color: #374151; font-weight: 600; margin-bottom: 0.5rem;">Issue</h4>
            <p style="color: #4b5563; line-height: 1.6;">${photo.issue}</p>
          </div>
        ` : ''}
        
        ${photo.description ? `
          <div>
            <h4 style="color: #374151; font-weight: 600; margin-bottom: 0.5rem;">Details</h4>
            <p style="color: #4b5563; line-height: 1.6;">${photo.description}</p>
          </div>
        ` : ''}
        
        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; color: #94a3b8; font-size: 0.85rem;">
          Photo ${index + 1} of ${galleryPhotos.length}
        </div>
      `;
      
      // Update navigation buttons
      document.querySelector('.modal-nav-prev').style.display = index > 0 ? 'block' : 'none';
      document.querySelector('.modal-nav-next').style.display = index < galleryPhotos.length - 1 ? 'block' : 'none';
      
      modal.classList.add('active');
    }
    
    // Navigate modal photos
    function navigateModal(direction) {
      const newIndex = currentPhotoIndex + direction;
      if (newIndex >= 0 && newIndex < galleryPhotos.length) {
        openPhotoFromGallery(newIndex);
      }
    }
    
    // Filter gallery items
    function filterGalleryItems() {
      const searchTerm = document.getElementById('gallerySearch').value.toLowerCase();
      const severityFilter = document.getElementById('severityFilter').value;
      
      if (currentView === 'gallery') {
        // Filter photo cards in gallery view
        document.querySelectorAll('.photo-card').forEach(card => {
          const matchesSearch = !searchTerm || card.dataset.searchable.includes(searchTerm);
          const matchesSeverity = severityFilter === 'all' || card.dataset.severity === severityFilter;
          card.style.display = matchesSearch && matchesSeverity ? 'block' : 'none';
        });
      } else {
        // Filter issue cards in report view
        document.querySelectorAll('.issue-card').forEach(card => {
          const matchesSearch = !searchTerm || card.dataset.searchable.includes(searchTerm);
          const matchesSeverity = severityFilter === 'all' || card.dataset.severity === severityFilter;
          card.style.display = matchesSearch && matchesSeverity ? 'block' : 'none';
        });
        
        // Hide sections with no visible issues
        document.querySelectorAll('.report-section').forEach(section => {
          const visibleIssues = section.querySelectorAll('.issue-card[style*="block"]').length;
          section.style.display = visibleIssues > 0 ? 'block' : 'none';
        });
      }
    }
    
    // Download PDF for current report
    function downloadCurrentPdf() {
      if (currentInspection && currentInspection.report_id) {
        downloadPdf(currentInspection.report_id);
      } else {
        alert('Please select an inspection report first.');
      }
    }
    
    // Initialize theme and stars
    document.addEventListener('DOMContentLoaded', function() {
      initTheme();
      generateStars();
    });
    
    // Keyboard navigation for modal
    document.addEventListener('keydown', (e) => {
      const modal = document.getElementById('photoModal');
      if (modal.classList.contains('active')) {
        if (e.key === 'Escape') {
          closeModal();
        } else if (e.key === 'ArrowLeft') {
          navigateModal(-1);
        } else if (e.key === 'ArrowRight') {
          navigateModal(1);
        }
      }
    });
    
    // Listen for theme changes from other tabs
    window.addEventListener('storage', (e) => {
      if (e.key === 'theme') {
        const isDark = e.newValue === 'dark';
        document.body.classList.toggle('dark-mode', isDark);
        const icon = document.getElementById('theme-icon');
        if (icon) icon.textContent = isDark ? '☀️' : '🌙';
      }
    });
  </script>
</body>
</html>